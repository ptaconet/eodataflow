---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%",
  eval = F
)
```
# eodataflow

<!-- badges: start -->
[![CRAN_Status_Badge](http://www.r-pkg.org/badges/version/eodataflow)](https://cran.r-project.org/package=eodataflow)
[![Github_Status_Badge](https://img.shields.io/badge/Github-0.0.9007-blue.svg)](https://github.com/ptaconet/eodataflow)
<!-- badges: end -->

[package in development...]

R workflow to automate the import of various kind of spatiotemporal earth observation data and eventually extract statistics around sampling points

functions to :
- import eo data given a roi and a one or more time frames
- extract statistics on buffers around sampling points for these time frames

# Example

## Setup packages

```{r setup_packages}
require(shub4r)
require(opendapr)
require(getremotedata)
require(eodataflow)
require(sf)
require(purrr)
require(dplyr)
require(tidyr)
require(raster)
require(furrr)
require(lubridate)
require(geosphere)
```

## Setup input parameters

```{r }
# Set ROI and time range of interest
roi <- st_as_sf(data.frame(geom="POLYGON ((-5.82 9.54, -5.42 9.55, -5.41 8.84, -5.81 8.84, -5.82 9.54))"), wkt="geom", crs = 4326)
roi_name <- "korhogo"
df_points_metadata <- st_read("/home/ptaconet/react/datasets/react_db.gpkg","entomo_csh_metadata_l1", stringsAsFactors=F) %>% st_drop_geometry() %>% dplyr::filter(codepays=="CI") %>% dplyr::select("idpointdecapture","date_capture","X","Y") %>% dplyr::rename(id=idpointdecapture,date=date_capture,longitude=X,latitude=Y)
#df_collections <- read.csv("wf_input_collections.csv",stringsAsFactors = F)
buffer_sizes <- c(500,1000,2000)
lag_time <- 40
parallel <- TRUE
verbose <- TRUE

```

## Logins

```{r logins}
# logins
# earthdata
username_earthdata <- Sys.getenv("earthdata_un")
password_earthdata <- Sys.getenv("earthdata_pw")
opendapr::odr_login(credentials = c(username_earthdata,password_earthdata),source = "earthdata")

# sentinel
instance_id_s1 <- Sys.getenv("instance_id_shub_s1")
instance_id_s2 <- Sys.getenv("instance_id_shub_s2")
shub4r::shr_login(instance_id_s1,source = "sentinel1")
shub4r::shr_login(instance_id_s2,source = "sentinel2")
```

## Preparation

```{r preparation}
# put the sampling points dataset in a format suitable for the next steps and generate the roi in sf format
df_sampling_points <- eodataflow::prepare_df_points(df_points_metadata)
roi <- eodataflow::prepare_roi(df_points_metadata,buffer_sizes)
```

Whenever possible, we will parallelize the script with the `furrr` package. We extend the maximum size to be exported for the `furrr` future expression to 20 GB.

```{r prepare_parralel, eval=F, echo=T}
plan(multiprocess)
options(future.globals.maxSize= 20000*1024^2) # 20 GB for the max size to be exported for the furrr future expression (https://stackoverflow.com/questions/40536067/how-to-adjust-future-global-maxsize-in-r)
```

## Workflow

### Time series

#### Weekly LST (MODIS)
```{r }
## Download :
# - MOD11A1.006 - variables LST_Day_1km and LST_Night_1km
# - MYD11A1.006 - variables LST_Day_1km and LST_Night_1km
variables <- c("LST_Day_1km","LST_Night_1km")
mod11a1 <- eodataflow::eodf_geturl_dl(times_start = df_sampling_points$date - lag_time,times_end = df_sampling_points$date, roi = roi, roi_name = roi_name, collection = "MOD11A1.006", variables = variables, parallel = parallel, verbose = verbose)
myd11a1 <- eodataflow::eodf_geturl_dl(times_start = df_sampling_points$date - lag_time,times_end = df_sampling_points$date, roi = roi, roi_name = roi_name, collection = "MYD11A1.006", variables = variables, parallel = parallel, verbose = verbose)

## Import :
# - MOD11A1.006 - LST day band 
# - MYD11A1.006 - LST day band 
# - MOD11A1.006 - LST nigth band 
# - MYD11A1.006 - LST nigth band 
rasts_lst_day_terra <- map(mod11a1$list_of_urls, ~opendapr::odr_import_data(.$destfile, "MOD11A1.006", "LST_Day_1km"))
rasts_lst_day_aqua <- map(myd11a1$list_of_urls, ~opendapr::odr_import_data(.$destfile, "MYD11A1.006", "LST_Day_1km"))
rasts_lst_night_terra <- map(mod11a1$list_of_urls, ~opendapr::odr_import_data(.$destfile, "MOD11A1.006", "LST_Night_1km"))
rasts_lst_night_aqua <- map(myd11a1$list_of_urls, ~opendapr::odr_import_data(.$destfile, "MYD11A1.006", "LST_Night_1km"))

## Create :
# - LST day combined MOD11A1.006 and MYD11A1.006 band
# - LST night combined MOD11A1.006 and MYD11A1.006 band
rasts_lst_max <- eodataflow::prepare_mixed_products(rasts_lst_day_terra,rasts_lst_day_aqua,"max")
rasts_lst_min <- eodataflow::prepare_mixed_products(rasts_lst_night_terra,rasts_lst_night_aqua,"min")

## Extract :
# - LST day Daily (aka. LST max)
# - LST nigth Daily (aka. LST min)
TMD <- eodataflow::extract_var_on_buffers(rasts_lst_max, df_sampling_points$sf_points, buffer_sizes, "mean", TRUE, df_sampling_points$date, code_indice = "TMD_M")
TMD$val <- TMD$val - 273.15
TND <- eodataflow::extract_var_on_buffers(rasts_lst_min, df_sampling_points$sf_points, buffer_sizes, "mean", TRUE, df_sampling_points$date, code_indice = "TND_M")
TND$val <- TND$val - 273.15

## Fill the NAs
TMD <- eodataflow::ts_fillna_l1tol3(TMD)
TND <- eodataflow::ts_fillna_l1tol3(TND)

## Compute the mean weekly temperature
function_8days <- function(TxD){

# compute mean weekly temperature 
TxD <- TxD %>%
  group_by(id,buffer,lag_n = lubridate::week(date)) %>%
  summarise(val=mean(val, na.rm = T),date = min(date)) %>%
  group_by(id,buffer) %>%
  mutate(lag_n=seq(n()-1,0,-1))

# fill the NAs
TxD <- TxD %>%
  mutate(qval=ifelse(!is.nan(val),1,0)) %>%
  eodataflow:::.ts_fillNA_l3(.,-1) %>%
  dplyr::select(-qval)

# get the column lag_time
TxD <- TxD %>%
  left_join(df_points_metadata, by = "id") %>%
  mutate(lag_time = as.numeric(as.Date(date.y) - date.x)) %>%
  dplyr::select(-c(date.y,longitude,latitude)) %>%
  rename(date = date.x)  

 return(TxD)
}

TMD <- function_8days(TMD)
TND <- function_8days(TND)

# Get temperature amplitude
TAW <- merge(TMD,TND,by=c("id","buffer","date","lag_n","lag_time")) %>%
  mutate(val = val.x-val.y) %>%
  dplyr::select(-c(val.x,val.y))

rm(rasts_lst_max,rasts_lst_min)
```

<!-- #### Weekly LST (MODIS) -->

<!-- The workflow is the same as for Daily temperatures (above), only the collections are changing -->

<!-- ```{r } -->
<!-- ## Download : -->
<!-- # - MOD11A2.006 - variables LST_Day_1km and LST_Night_1km -->
<!-- # - MYD11A2.006 - variables LST_Day_1km and LST_Night_1km -->
<!-- variables <- c("LST_Day_1km","LST_Night_1km") -->
<!-- mod11a2 <- eodataflow::eodf_geturl_dl(times_start = df_sampling_points$date - lag_time,times_end = df_sampling_points$date, roi = roi, roi_name = roi_name, collection = "MOD11A2.006", variables = variables, parallel = parallel, verbose = verbose) -->
<!-- myd11a2 <- eodataflow::eodf_geturl_dl(times_start = df_sampling_points$date - lag_time,times_end = df_sampling_points$date, roi = roi, roi_name = roi_name, collection = "MYD11A2.006", variables = variables, parallel = parallel, verbose = verbose) -->
<!-- ## Import : -->
<!-- # - MOD11A2.006 - LST day band  -->
<!-- # - MYD11A2.006 - LST day band  -->
<!-- # - MOD11A2.006 - LST nigth band  -->
<!-- # - MYD11A2.006 - LST nigth band  -->
<!-- rasts_lst_day_terra <- map(mod11a2$list_of_urls, ~opendapr::odr_import_data(.$destfile, "MOD11A2.006", "LST_Day_1km")) -->
<!-- rasts_lst_day_aqua <- map(myd11a2$list_of_urls, ~opendapr::odr_import_data(.$destfile, "MYD11A2.006", "LST_Day_1km")) -->
<!-- rasts_lst_night_terra <- map(mod11a2$list_of_urls, ~opendapr::odr_import_data(.$destfile, "MOD11A2.006", "LST_Night_1km")) -->
<!-- rasts_lst_night_aqua <- map(myd11a2$list_of_urls, ~opendapr::odr_import_data(.$destfile, "MYD11A2.006", "LST_Night_1km")) -->

<!-- ## Create : -->
<!-- # - LST day combined MOD11A2.006 and MYD11A2.006 band -->
<!-- # - LST night combined MOD11A2.006 and MYD11A2.006 band -->
<!-- rasts_lst_max <- eodataflow::prepare_mixed_products(rasts_lst_day_terra,rasts_lst_day_aqua,"max") -->
<!-- rasts_lst_min <- eodataflow::prepare_mixed_products(rasts_lst_night_terra,rasts_lst_night_aqua,"min") -->

<!-- ## Extract : -->
<!-- # - LST day Weekly (aka. LST max) -->
<!-- # - LST nigth Weekly (aka. LST min) -->
<!-- TMW_M <- eodataflow::extract_var_on_buffers(rasts_lst_max, df_sampling_points$sf_points, buffer_sizes, "mean", TRUE, df_sampling_points$date, code_indice = "TMW_M") -->
<!-- TMW_M$val <- TMW_M$val - 273.15 -->
<!-- TNW_M <- eodataflow::extract_var_on_buffers(rasts_lst_min, df_sampling_points$sf_points, buffer_sizes, "mean", TRUE, df_sampling_points$date, code_indice = "TNW_M") -->
<!-- TNW_M$val <- TNW_M$val - 273.15 -->

<!-- rm(rasts_lst_max,rasts_lst_min) -->
<!-- ``` -->

<!-- Fill the NAs in daily and weekly products :  -->

<!-- ```{r } -->
<!-- # Fill NAs for Daily and Weekly maximum temperature -->
<!-- TMx_M_nafill <- eodataflow::ts_fillna_l1tol5(TMD_M,TMW_M) -->
<!-- TMD_M <- TMx_M_nafill[[1]] -->
<!-- TMW_M <- TMx_M_nafill[[2]] -->

<!-- # Fill NAs for Daily and Weekly minimum temperature -->
<!-- TNx_M_nafill <- eodataflow::ts_fillna_l1tol5(TND_M,TNW_M) -->
<!-- TND_M <- TNx_M_nafill[[1]] -->
<!-- TNW_M <- TNx_M_nafill[[2]] -->
<!-- ``` -->

#### Vegetation indices (MODIS)
```{r }
## Download :
# - MOD13Q1.006 - variables _250m_16_days_NDVI and _250m_16_days_EVI
# - MYD13Q1.006 - variables _250m_16_days_NDVI and _250m_16_days_EVI
variables <- c("_250m_16_days_NDVI","_250m_16_days_EVI")
mod13q1 <- eodataflow::eodf_geturl_dl(times_start = df_sampling_points$date - lag_time,times_end = df_sampling_points$date, roi = roi, roi_name = roi_name, collection = "MOD13Q1.006", variables = variables, parallel = parallel, verbose = verbose)
myd13q1 <- eodataflow::eodf_geturl_dl(times_start = df_sampling_points$date - lag_time,times_end = df_sampling_points$date, roi = roi, roi_name = roi_name, collection = "MYD13Q1.006", variables = variables, parallel = parallel, verbose = verbose)

## Import :
# - MOD13Q1.006 - _250m_16_days_NDVI
# - MYD13Q1.006 - _250m_16_days_NDVI
# - MOD13Q1.006 - _250m_16_days_EVI
# - MYD13Q1.006 - _250m_16_days_EVI
rasts_veget_ndvi_terra <- map(mod13q1$list_of_urls, ~opendapr::odr_import_data(.$destfile, "MOD13Q1.006", "_250m_16_days_NDVI"))
rasts_veget_ndvi_aqua <- map(myd13q1$list_of_urls, ~opendapr::odr_import_data(.$destfile, "MYD13Q1.006", "_250m_16_days_NDVI"))
rasts_veget_evi_terra <- map(mod13q1$list_of_urls, ~opendapr::odr_import_data(.$destfile, "MOD13Q1.006", "_250m_16_days_EVI"))
rasts_veget_evi_aqua <- map(myd13q1$list_of_urls, ~opendapr::odr_import_data(.$destfile, "MYD13Q1.006", "_250m_16_days_EVI"))

## Extract :
# - NDVI
# - EVI
VNI_terra <- eodataflow::extract_var_on_buffers(rasts_veget_ndvi_terra, df_sampling_points$sf_points, buffer_sizes, "mean", TRUE, df_sampling_points$date, code_indice = "VNI_M")
VNI_aqua <- eodataflow::extract_var_on_buffers(rasts_veget_ndvi_aqua, df_sampling_points$sf_points, buffer_sizes, "mean", TRUE, df_sampling_points$date, code_indice = "VNI_M")
VNI_M <- rbind(VNI_terra,VNI_aqua) %>% arrange(id,buffer,date)

VEI_terra <- eodataflow::extract_var_on_buffers(rasts_veget_evi_terra, df_sampling_points$sf_points, buffer_sizes, "mean", TRUE, df_sampling_points$date, code_indice = "VEI_M")
VEI_aqua <- eodataflow::extract_var_on_buffers(rasts_veget_evi_aqua, df_sampling_points$sf_points, buffer_sizes, "mean", TRUE, df_sampling_points$date, code_indice = "VEI_M")
VEI_M <- rbind(VEI_terra,VEI_aqua) %>% arrange(id,buffer,date)

## Fill the NAs
VNI_M <- eodataflow::ts_fillna_l1tol3(VNI_M)
VEI_M <- eodataflow::ts_fillna_l1tol3(VEI_M)

rm(rasts_veget_ndvi_terra,rasts_veget_ndvi_aqua,rasts_veget_evi_terra,rasts_veget_evi_aqua)
```

#### Evapotransipation (MODIS)
```{r }
## Download :
# - MOD16A2.006 - variables ET_500m
# - MYD16A2.006 - variables ET_500m
variables <- c("ET_500m")
mod16a2 <- eodataflow::eodf_geturl_dl(times_start = df_sampling_points$date - lag_time,times_end = df_sampling_points$date, roi = roi, roi_name = roi_name, collection = "MOD16A2.006", variables = variables, parallel = parallel, verbose = verbose)
myd16a2 <- eodataflow::eodf_geturl_dl(times_start = df_sampling_points$date - lag_time,times_end = df_sampling_points$date, roi = roi, roi_name = roi_name, collection = "MYD16A2.006", variables = variables, parallel = parallel, verbose = verbose)

## Import :
# - MOD16A2.006 - ET_500m
# - MYD16A2.006 - ET_500m
rasts_et_terra <- map(mod16a2$list_of_urls, ~opendapr::odr_import_data(.$destfile, "MOD16A2.006", "ET_500m"))
rasts_et_aqua <- map(myd16a2$list_of_urls, ~opendapr::odr_import_data(.$destfile, "MYD16A2.006", "ET_500m"))

## Create :
# - ET combined MOD16A2.006 and MYD16A2.006 band
rasts_et_terra2 <- rasts_et_terra %>%
  map(., ~clamp(.x, upper=32760, useValues=FALSE)) %>% ## Set pixel values >= 32760 (quality pixel values) to NA 
  map2(.x = ., .y = rasts_et_terra, ~magrittr::set_names(.x,names(.y)))
rasts_et_aqua2 <- rasts_et_aqua %>%
  map(., ~clamp(.x, upper=32760, useValues=FALSE)) %>% ## Set pixel values >= 32760 (quality pixel values) to NA 
  map2(.x = ., .y = rasts_et_aqua, ~magrittr::set_names(.x,names(.y)))

rasts_et <- eodataflow::prepare_mixed_products(rasts_et_terra2,rasts_et_aqua2,"mean")

## Extract :
# - Evapotranspiration
EVT <- eodataflow::extract_var_on_buffers(rasts_et, df_sampling_points$sf_points, buffer_sizes, "mean", TRUE, df_sampling_points$date, code_indice = "EVT")

## Fill the NAs
EVT <- eodataflow::ts_fillna_l1tol3(EVT)
```

#### Soil moisture (SMAP)
```{r warning=F}
## Download :
# - SPL3SMP_E.003 - variables "Soil_Moisture_Retrieval_Data_AM_soil_moisture","Soil_Moisture_Retrieval_Data_PM_soil_moisture_pm"
variables <- c("Soil_Moisture_Retrieval_Data_AM_soil_moisture","Soil_Moisture_Retrieval_Data_PM_soil_moisture_pm")
smap <- eodataflow::eodf_geturl_dl(times_start = df_sampling_points$date - lag_time,times_end = df_sampling_points$date, roi = roi, roi_name = roi_name, collection = "SPL3SMP_E.003", variables = variables, parallel = parallel, verbose = verbose)

## Import :
# - SPL3SMP_E.003 - Soil_Moisture_Retrieval_Data_AM_soil_moisture
# - SPL3SMP_E.003 - Soil_Moisture_Retrieval_Data_PM_soil_moisture_pm
opt_param <- opendapr::odr_get_opt_param("SPL3SMP_E.003",roi)
rasts_smap_am <- map(smap$list_of_urls, ~opendapr::odr_import_data(.$destfile, "SPL3SMP_E.003", "Soil_Moisture_Retrieval_Data_AM_soil_moisture", opt_param = opt_param))
rasts_smap_pm <- map(smap$list_of_urls, ~opendapr::odr_import_data(.$destfile, "SPL3SMP_E.003", "Soil_Moisture_Retrieval_Data_PM_soil_moisture_pm", opt_param = opt_param))

## Create :
# - ET combined AM and PM band
rasts_smap <- eodataflow::prepare_mixed_products(rasts_smap_am,rasts_smap_pm,"mean")

## Extract :
# - soil moisture
SMO <- eodataflow::extract_var_on_buffers(rasts_smap, df_sampling_points$sf_points, buffer_sizes, "mean", TRUE, df_sampling_points$date, code_indice = "SMO")

## Fill the NAs
SMO <- eodataflow::ts_fillna_l1tol3(SMO)
```

#### Daily Precipitation (GPM)
```{r }
## Download :
# - GPM_3IMERGDL.06 - variable precipitationCal
variables <- c("precipitationCal")
gpm <- eodataflow::eodf_geturl_dl(times_start = df_sampling_points$date - lag_time,times_end = df_sampling_points$date, roi = roi, roi_name = roi_name, collection = "GPM_3IMERGDL.06", variables = variables, parallel = parallel, verbose = verbose)

## Import :
# - GPM_3IMERGDL.06 - precipitationCal
rasts_gpm <- map(gpm$list_of_urls, ~opendapr::odr_import_data(.$destfile, "GPM_3IMERGDL.06", "precipitationCal"))

## Create :
# - GPM resampled to 250 m
rasts_gpm <- map(rasts_gpm, ~eodataflow:::.resample_rast(.,250))

## Extract :
# - daily rainfall
RFD_G <- eodataflow::extract_var_on_buffers(rasts_gpm, df_sampling_points$sf_points, buffer_sizes, "mean", TRUE, df_sampling_points$date, code_indice = "RFD_G")
RFD_G$val[which(RFD_G$val<0)] <- 0
RFD_G$qval <- 1
rm(rasts_gpm)
```


### Monthly data

#### RS indices - NDWI, NDVI, BRI, MNDWI, MNDVI (Sentinel 2) (monthly average)

```{r }
## Download :
# -S2L2A - variables "B03","B04","B08","B11","9_SCENE_CLASSIFICATION"
variables <- c("B03","B04","B08","B11","9_SCENE_CLASSIFICATION")
spectral_indices=c("ndvi","mndvi","ndwi","mndwi","bri")
s2l2a <- eodataflow::eodf_geturl_dl(times_start = df_sampling_points$date - 30,times_end = df_sampling_points$date, roi = roi, roi_name = roi_name, collection = "S2L2A", variables = variables, parallel = parallel, verbose = verbose)

SPI <- NULL
for(i in 1:length(s2l2a$list_of_urls)){
  cat("Calculating spectral indices n° ",i," over",length(s2l2a$list_of_urls),"\n")
  if(!(nrow(s2l2a$list_of_urls[[i]])==1 && is.na(s2l2a$list_of_urls[[i]]$time_start))){   # case there are not images available
    rasts_spec_ind <- eodataflow::prepare_s2_indices(s2l2a$list_of_urls[[i]],variables,spectral_indices)
    SPI <- rbind(SPI,eodataflow::extract_var_on_buffers(rasts_spec_ind, df_sampling_points$sf_points[[i]], buffer_sizes, na_max_perc = 50, verbose = TRUE ))  # buffers with more than na_max_perc % of cells containing NA values will be set to NA
  }
}

# fill NAs
#TODO
```

#### Nighttime lights (VIIRS) (monthly average)

```{r }
## Download :
# - VIIRS_DNB_MONTH - variable Monthly_AvgRadiance,Monthly_CloudFreeCoverage
variables <- c("Monthly_AvgRadiance","Monthly_CloudFreeCoverage")
viirsdnb <- eodataflow::eodf_geturl_dl(times_start = df_sampling_points$date - 1,times_end = df_sampling_points$date, roi = roi, roi_name = roi_name, collection = "VIIRS_DNB_MONTH", variables = variables, parallel = parallel, verbose = verbose)

## Import :
# - VIIRS_DNB_MONTH - Monthly_AvgRadiance
# - VIIRS_DNB_MONTH - Monthly_CloudFreeCoverage
rasts_AvgRadiance <- map(viirsdnb$list_of_urls, ~getremotedata::grd_import_data(., "VIIRS_DNB_MONTH", "Monthly_AvgRadiance"))
rasts_CloudFreeCoverage <- map(viirsdnb$list_of_urls, ~getremotedata::grd_import_data(., "VIIRS_DNB_MONTH", "Monthly_CloudFreeCoverage"))

## Create :
# - VIIRS_DNB_MONTH with quality : if there are 0 cloud free obs, we set the pixel to NA
rasts_CloudFreeCoverage <- map(rasts_CloudFreeCoverage,~clamp(.x,lower=1,useValues=FALSE))
rasts_AvgRadiance <- map2(rasts_AvgRadiance,rasts_CloudFreeCoverage,~mask(.x,.y)) # Quality control : if there are 0 cloud free obs, we set the pixel to NA

## Extract :
# - average radiance
LNL <- eodataflow::extract_var_on_buffers(rasts_AvgRadiance, df_sampling_points$sf_points, buffer_sizes, "mean", TRUE, df_sampling_points$date, code_indice = "LNL")
LNL$qval <- 1
rm(rasts_CloudFreeCoverage,rasts_AvgRadiance)
```


### Data covering the sampling night

#### Half-hourly precipitation (GPM) (night average)
```{r }
## Download :
# - GPM_3IMERGHH.06 - variables "precipitationCal","precipitationQualityIndex"
variables <- c("precipitationCal","precipitationQualityIndex")
gpm <- eodataflow::eodf_geturl_dl(times_start = as.POSIXlt(paste0(df_sampling_points$date, "18:00:00")),times_end = as.POSIXlt(paste0(df_sampling_points$date+1, "08:00:00")), roi = roi, roi_name = roi_name, collection = "GPM_3IMERGHH.06", variables = variables, parallel = parallel, verbose = verbose)

## Import :
# - GPM_3IMERGHH.06 - precipitationCal
# - GPM_3IMERGHH.06 - precipitationQualityIndex
rasts_gpm_precip <- map(gpm$list_of_urls, ~opendapr::odr_import_data(.$destfile, "GPM_3IMERGHH.06", "precipitationCal"))
#rasts_gpm_qa <- map(gpm$list_of_urls, ~opendapr::odr_import_data(.$destfile, "GPM_3IMERGHH.06", "precipitationQualityIndex"))

## Create :
# - GPM_3IMERGHH.06 with quality : Set pixel values <= 0.4 (quality pixel values) to NA. See https://pmm.nasa.gov/sites/default/files/document_files/IMERGV06_QI.pdf for additional info (threshold of 0.4 is given in this doc)
#rasts_gpm_qa2 <- map(rasts_gpm_qa,~clamp(.x,lower=0.4,useValues=FALSE))

## Create :
# - GPM resampled to 250 m
rasts_gpm_precip <- future_map(rasts_gpm_precip, ~eodataflow:::.resample_rast(.,250))
# Set pixel to 1 if there was rain (precip. >=0.05mm), else 0 
rasts_gpm_precip <- map(rasts_gpm_precip,~raster::reclassify(.,c(-Inf,0.05,0, 0.05,Inf,1)))

# reset names for the raster
rasts_gpm_precip <- map2(rasts_gpm_precip, gpm$list_of_urls, ~magrittr::set_names(.x, .y$time_start))

RFH <- eodataflow::extract_var_on_buffers(rasts_gpm_precip, df_sampling_points$sf_points, buffer_sizes = 10, "mean", TRUE, df_sampling_points$date, code_indice = "RFH")
# With this we get if is has rain (1) or not (0) for each half hour of each night (ie the lag). Note that there is only 1 cell intersected (i.e. buffer_sizes=10) so the summurazing function is quite useless
# Now we extract the variable that we want: the proportion of half-hours where it has rained for the total duration of each night. 
RFH <- RFH %>%
  group_by(id,buffer,var) %>% 
  summarise(val=round(sum(val)/n()*100)) %>%
  left_join(df_points_metadata,by="id") %>%
  dplyr::select(-c(longitude,latitude)) %>%
  mutate(qval=1,lag_time = 0,lag_n = 0)

rm(rasts_gpm_precip)

```

#### Wind (ERA5) (night average)
```{r }
## Download :
# - ERA5 - variable 10m_u_component_of_wind,10m_v_component_of_wind
# we take an area wider than the ROI, because if we take just the roi we have only 4 cells, which is too less to resample
variables <- c("10m_u_component_of_wind","10m_v_component_of_wind")
wind <- eodataflow::eodf_geturl_dl(times_start = as.POSIXlt(paste0(df_sampling_points$date, "18:00:00")),times_end = as.POSIXlt(paste0(df_sampling_points$date+1, "08:00:00")), roi = st_buffer(roi,1), roi_name = roi_name, collection = "ERA5", variables = variables, parallel = parallel, min_filesize = 70, verbose = verbose )

## Import :
rasts_wind_u10 <- map(wind$list_of_urls, ~getremotedata::grd_import_data(., "ERA5", variable = "u10"))
rasts_wind_v10 <- map(wind$list_of_urls, ~getremotedata::grd_import_data(., "ERA5", variable = "v10"))

## Prepare (source: https://stackoverflow.com/questions/21484558/how-to-calculate-wind-direction-from-u-and-v-wind-components-in-r)
rasts_wind_speed <- prepare_mixed_products(rasts_wind_u10,rasts_wind_v10,"sqrt_squared")
rast_wind_dir_cardinal <- prepare_mixed_products(rasts_wind_u10,rasts_wind_v10,"atan2") %>%
  map(~.*180/pi) %>%
  map(~.+180)

# resample wind speed but not wind direction 
rasts_wind_speed<- map(rasts_wind_speed, ~eodataflow:::.resample_rast(.,250))

### Extract
# Wind speed
WSP <- eodataflow::extract_var_on_buffers(rasts_wind_speed, df_sampling_points$sf_points, buffer_sizes = 10, "mean", TRUE, df_sampling_points$date, code_indice = "WSP")
WSP <- WSP %>%
  group_by(id,buffer,var) %>% 
  summarise(val=mean(val, na.rm = T)) %>%
  left_join(df_points_metadata,by="id") %>%
  dplyr::select(-c(longitude,latitude)) %>%
  mutate(qval=1,lag_time = 0,lag_n = 0)
rm(rasts_wind_speed)

# Wind direction
# formula :  https://en.wikipedia.org/wiki/Mean_of_circular_quantities (see section "Example")
WDR <- eodataflow::extract_var_on_buffers(rast_wind_dir_cardinal, df_sampling_points$sf_points, buffer_sizes = 10, "mean", TRUE, df_sampling_points$date, code_indice = "WDR")
WDR <- WDR %>%
  mutate(sin_angle=sin(val*(pi/180))) %>%
  mutate(cos_angle=cos(val*(pi/180))) %>%
  group_by(id,buffer,var) %>% 
  summarise(mean_sin=mean(sin_angle,na.rm=T),mean_cos=mean(cos_angle,na.rm=T)) %>% 
  mutate(val=atan(mean_sin/mean_cos)/(pi/180)) %>%
  mutate(val=case_when(mean_sin>0 & mean_cos>0 ~ val,
                       mean_cos<0 ~ val+180,                           
                       mean_sin<0 & mean_cos>0 ~ val+360)) %>%
  dplyr::select(id,buffer,val) %>%
  left_join(df_points_metadata,by="id") %>%
  dplyr::select(-c(longitude,latitude)) %>%
  mutate(qval=1,lag_time = 0,lag_n = 0)

rm(rasts_wind_dir_cardinal)

```

#### Moon illumination
```{r }
## Download :
moon <- eodataflow::eodf_geturl_dl(times_start = df_sampling_points$date,times_end = df_sampling_points$date, roi = roi, roi_name = roi_name, collection = "MIRIADE", variables = variables, parallel = parallel, verbose = verbose,min_filesize=300)

## Import :
moon <- map(moon$list_of_urls, ~getremotedata::grd_import_data(., "MIRIADE"))

## Extract :
# - average radiance
LMN <- map2_dfr(df_sampling_points$sf_points,moon,~data.frame(.x$id,.y[[1]]$V.Mag))

LMN <- LMN %>%
  magrittr::set_colnames(c("id","val")) %>%
  mutate(var = "LMN", buffer = NA, qval = 1, lag_time = 0, lag_n = 0) %>%
  left_join(df_points_metadata, by = "id") %>%
  dplyr::select(-c(latitude,longitude))
```

#### Daytime length

```{r }
# the daylength function of the geosphere package does the job

day_length <- map2(.x = df_sampling_points$sf_points, .y = df_sampling_points$date, ~geosphere::daylength(mean(st_coordinates(.x[,2])),lubridate::yday(.y)))

DLG <- map2(df_sampling_points$sf_points, day_length, ~mutate(.x, val =.y )) %>%
  map(st_drop_geometry) %>%
  do.call(rbind,.) %>%
  mutate(var = "DLG", buffer = NA, qval = 1, lag_time = 0, lag_n = 0) %>%
  left_join(df_points_metadata, by = "id") %>%
  dplyr::select(-c(latitude,longitude))

```

### Non time series


